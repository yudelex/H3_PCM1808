### Использование ADC PCM1808 в связке с SoC Allwinner H3 в OS Armbian.



#### Введение.

​	АЦП PCM1808 и его аналоги представляют собой неуправляемый чип, который требует на входах: фиксируемые конфигурационные значения режима работы (master/slave) и формата передачи данных (I2S), а так же сигналов тактирования и смены канала захвата звука (должны быть синхронизированы).
​	Поскольку для включения захвата звука посредством АЦП применяется интерфейс IS2 который сам генерирует необходимые сигналы, нет необходимости в использовании специального драйвера. Достаточно создать оверлей на Device Tree (далее DT) в котором прописать звуковое устройство и кодек, затем включить интерфейс I2S, потом создать и собрать модуль звукового устройства. После загрузки, ядро прочитает оверлей и увидит, что к шине I2S подключено некое звуковое устройство. При записи звука, ядро, посредством модуля звукового устройства сможет через DMA читать буфер PCM в который будут помещаться данные через порт DIN (PA21) SoC H3.

**В данном руководстве используется операционная система Armbian_24.11.1_Orangepione_bookworm_current_6.6.62_minimal.**



#### Подготовительные процедуры.

##### Электрическая коммутация аппаратного обеспечения.

| H3 pin name | H3 pin # | PCM1808 pin name | PCM1808 pin # |
| ----------- | :------- | :--------------- | ------------- |
| SCLK        | PA19     | BCLK             | 8             |
| SYNC        | PA18     | SCLI (MCLK)      | 6             |
| DIN         | PA21     | DOUT             | 9             |

##### Конфигурация аппаратного обеспечения.

| PCM1808 pin name | PCM1808 pin # | STATE | MODE        |
| :--------------- | :------------ | :---- | :---------- |
| MD0/MD1          | 10/11         | LOW   | SLAVE       |
| FMT              | 12            | LOW   | I2S, 24 bit |

##### Установка необходимого программного обеспечения и исходных кодов.

sudo apt-get update && sudo apt-get upgrade

sudo apt install git

sudo apt install make

sudo apt install patch

sudo apt install git build-essential linux-headers-current-sunxi -y

ls -al /lib/modules/$(uname -r)/build

git clone https://github.com/yudelex/H3_PCM1808.git

cd H3_PCM1808/

##### Внесение изменений в DT и файлы сборки модуля ядра.

sudo armbian-add-overlay pcm1808.dts

sudo patch -d/ -p0 < pcm1808.patch

##### Сборка модуля ядра и включение модуля в загрузку.

cd codecs/

make all && sudo make install

sudo reboot

##### Проверка наличия модуля и звукового устройства в системе.

lsmod | grep pcm1808

arecord -l

arecord -L

#### 

#### Отладка модуля ядра.

Для отладки лучше всего использовать последовательный терминал и подключиться к SoC через интерфейс UART0 посредством конвертера интерфейсов USB to Serial. Таким образом, при падении системы можно будет наблюдать сообщения ядра в терминале.

##### Электрическая коммутация аппаратного обеспечения.

| H3 pin name | H3 pin # |
| :---------- | :------- |
| UART0_TX    | PA4      |
| UART0_RX    | PA5      |
| GND         | GND      |

Отладка модуля ядра производится посредством kgdb. Более подробную информацию смотрите здесь: https://www.kernel.org/doc/html/v6.6/dev-tools/kgdb.html
